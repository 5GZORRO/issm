# Copyright 2020 - 2021 IBM Corporation

# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at

# http://www.apache.org/licenses/LICENSE-2.0

# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

apiVersion: argoproj.io/v1alpha1
kind: WorkflowTemplate
metadata:
  name: orchestration-template
spec:
  templates:
  - name: handle-orchestration
    dag:
      tasks:
      - name: nsso-create-vsd
        templateRef:
          name: workflow-slice
          template: create-descriptor
        arguments:
          parameters:
          - name: nsso_ip
            value: "{{workflow.parameters.nsso_ip}}"
          - name: nsso_port
            value: "{{workflow.parameters.nsso_port}}"
          - name: tenant_name
            value: "{{workflow.parameters.resource_owner}}"
          - name: blueprint_name
            value: "{{workflow.parameters.resource_vsb}}"
          - name: parameters
            value: "{{workflow.parameters.qos_parameters}}"

      - name: nsso-create-vsi
        dependencies: [nsso-create-vsd]
        templateRef:
          name: workflow-slice
          template: create-instance
        arguments:
          parameters:
          - name: nsso_ip
            value: "{{workflow.parameters.nsso_ip}}"
          - name: nsso_port
            value: "{{workflow.parameters.nsso_port}}"
          - name: tenant_name
            value: "{{workflow.parameters.resource_owner}}"
          - name: vsd_id
            value: "{{tasks.nsso-create-vsd.outputs.parameters.vsd_id}}"
          - name: name
            value: "{{workflow.parameters.resource_vsb}}"
          - name: userdata
            value: |
              { "product_id": "{{workflow.parameters.product_id}}",
                "transaction_id": "{{workflow.parameters.transaction_uuid}}",
                "vsi_id": "{{workflow.parameters.service_id}}" }

      - name: nsso-poll
        dependencies: [nsso-create-vsi]
        templateRef:
          name: workflow-slice
          template: poll
        arguments:
          parameters:
          - name: poll
            value: "true"
          - name: nsso_ip
            value: "{{workflow.parameters.nsso_ip}}"
          - name: nsso_port
            value: "{{workflow.parameters.nsso_port}}"
          - name: tenant_name
            value: "{{workflow.parameters.resource_owner}}"
          - name: vsi_id
            value: "{{tasks.nsso-create-vsi.outputs.parameters.vsi_id}}"
          - name: jq_query
            value: ".status"
          - name: jq_query_value
            value: "INSTANTIATED"
          - name: timeout
            value: 30

#      - name: poll-timeout
#        dependencies: [nsso-poll]
#        templateRef:
#          name: workflow-base
#          template: fail
#        when: "{{tasks.nsso-poll.outputs.parameters.status}} == \"TIMEOUT\""

      - name: sla-event
        dependencies: [nsso-poll]
#        when: "{{tasks.nsso-poll.outputs.parameters.status}} != \"TIMEOUT\""
        templateRef:
          name: workflow-base
          template: produce
        arguments:
          parameters:
          - name: data
            value: |
              { "eventType": "new_SLA",
                "transactionID": "{{workflow.parameters.transaction_uuid}}",
                "productID": "{{workflow.parameters.product_id}}",
                "instanceID": "{{tasks.nsso-create-vsi.outputs.parameters.vsi_id}}",
                "slaID": "{{workflow.parameters.sla_id}}",
                "kafka_ip": "{{workflow.parameters.kafka_ip}}", "kafka_port": "{{workflow.parameters.kafka_port}}",
                "topic": "isbp-topic-out"
              }
          - name: kafka_topic
            value: "isbp-topic"
          - name: kafka_ip
            value: "{{workflow.parameters.kafka_dl_ip}}"
          - name: kafka_port
            value: "{{workflow.parameters.kafka_dl_port}}"
